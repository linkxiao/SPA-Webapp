define("saber-firework/main",["require","saber-emitter","saber-promise","fastclick","saber-lang/extend","saber-lang/bind","saber-lang/curry","saber-viewport","saber-mm","./config","saber-router","saber-router/controller/hash"],function(require){function e(e){var t=R.processor||{};return t[e]}function t(e){e.done()}function n(){var e;Object.keys(C).forEach(function(t){if(e=C[t],T.action!==e)e.dispose()}),C={},x.delCache()}function r(e){var t=C[e];if(t){if(T.action!==t)t.dispose();delete C[e],x.delCache(e)}}function i(e,t,n){if(e){if(T.action=e,t.cached)C[t.path]=e}else T.action=null;T.route=t,T.page=n,T.path=t.path}function o(n,r){function o(e){if(clearTimeout(p),h("beforetransition"),i(!e&&r,n,f),e)return f.enter(c.type,c).then(y(m.rejected,m));else return f.enter(c.type,c)}function s(){return h("error"),o(!0)}function a(){g.forEach(function(e){r[e]()}),t(n)}var u=n.options||{},c=n.transition||{},l=e("transition");if(l)v(c,l(n,T.route)||{});if(n.path===T.path)c.type=!1;var f=x.load(n.path,{cached:n.cached,noCache:u.noCache}),h=function(e,t){return function(n){exports.emit(n,e,t)}}({route:v({},n),action:r,page:f},{route:v({},T.route),action:T.action,page:T.page});f.on("afterenter",E(h,"afterload")),h("beforeload");var p,d,g=["complete"],b=[n.path,n.query,u];if(!C[n.path])d="enter",b.unshift(f.main),g.unshift("ready");else d="wakeup",g.unshift("revived");p=setTimeout(E(t,n),R.timeout),r[d].apply(r,b).then(o,s).then(a,E(t,n))}function s(e){var n=e.options||{};if(e.path!==T.path||n.force||!T.action||!T.action.refresh){if(n.noCache)r(e.path);if(T.action)T.action[C[T.path]?"sleep":"leave"]();var i=C[e.path];if(!i)b.create(e.action).then(E(o,e));else o(e,i)}else{var s=T.action.refresh(e.query,e.options);if(!s||"function"!=typeof s.then)t(e);else s.then(E(t,e))}}function a(e){function t(e){i+=e||w.length,n()}function n(){var o=w[i++];if(!o)r.resolve(e);else if(!o.url||o.url instanceof RegExp&&o.url.test(e.path)||o.url===e.path)o.filter(e,n,t);else n()}var r=new m,i=0;return n(),r.promise()}function u(e){var t=v({},window[R.syncDataKey]);return e?t[e]:t}function c(e,n,r){function o(t){exports.emit(t,{route:null,action:null,page:null},{route:e,action:r,page:n})}o("beforeload"),r.set(e.path),r.view.set(n.main),r.model.fill(u("model")),o("beforetransition"),r.ready(!0),r.complete(),o("afterload"),i(r,e,n),t(e)}function l(e){function n(e){if(o!==e.path)R.router.redirect(e.path,e.query,e.options),t(i);else s(e)}var r,i=e,o=e.path;if(R.isomorphic&&!T.action&&(r=x.front(o,{cached:e.cached})))return void b.create(e.action).then(E(c,e,r));else return void a(e).then(n)}function f(e){return function(t,n,r,i,o,s){var a=v({},e);a.path=t,a.query=v(r,n),a.options=o,a.url=i,a.done=s,l(a)}}function h(e){var t=v(R,e);if(t.templateData=v({},u("templateData"),t.templateData),!Array.isArray(t.template))t.template=[t.template];if(!t.router)t.router=require("saber-router"),t.router.controller(require("saber-router/controller/hash"));return t}function p(e){var t={},n=["template","templateConfig","templateData","router","Presenter","View","Model"];return n.forEach(function(n){if(n in e)t[n]=e[n]}),t}var d=require("saber-emitter"),m=require("saber-promise"),g=require("fastclick"),v=require("saber-lang/extend"),y=require("saber-lang/bind"),E=require("saber-lang/curry"),x=require("saber-viewport"),b=require("saber-mm"),R=require("./config"),w=[],C={},T={},exports={};d.mixin(exports);var k=[];return exports.load=function(e){if(!Array.isArray(e))e=[e];if(!R.router)k=k.concat(e);else e.forEach(function(e){R.router.add(e.path,f(e))})},exports.start=function(e,t){var n=h(t),r=n.router;b.config(p(n)),x.init(e,n.viewport),g.attach(document.body),k.forEach(function(e){r.add(e.path,f(e))}),r.config({path:n.path,index:n.index,root:n.root}),r.start()},exports.addFilter=function(e,t){if(1===arguments.length)t=e,e=null;w.push({url:e,filter:t})},exports.removeFilter=function(e){if(!e)w=[];else{var t,n=w.some(function(n,r){return t=r,n.url.toString()===e.toString()});if(n)w.splice(t,1)}},exports.delCachedAction=function(e){if(e)r(e);else n()},exports.stop=function(){var e=R.router;e.stop(),e.clear(),k=[],w=[],T={},exports.delCachedAction()},exports.getSyncData=u,exports}),define("saber-firework",["saber-firework/main"],function(e){return e});