define("saber-widget/LinkageMenu",["require","saber-lang","saber-string","./Widget","saber-dom","saber-scroll","saber-scroll/plugin/scrollbar","saber-emitter","./main"],function(require){function e(e){if(void 0===e)return null;if(/^\d+$/.test(e))e=parseInt(e,10);return e}function t(e){this._root={name:"root",value:"root",level:0,children:e},this._depth=0,this._preprocess()}function n(t){this.next=null,this.value=e(t.value),this.uniqueValue=e(t.uniqueValue),this.data=null,this.main=document.createElement("div"),this.main.className="linkage-item",this.ul=document.createElement("ul"),this.main.appendChild(this.ul),this.render(t.data),this._changeHandler=i.bind(this._changeHandler,this),this.main.addEventListener("click",this._changeHandler,!1)}function r(){this.attrs={datasource:{value:[]},values:{value:[],setter:function(e){for(var t=[],e=e.slice(0),n=0,r=e.length;r>n;n++){var i=["root"].concat(e.slice(0,n+1));t.push(i.join("-"))}this.set("uniqueValues",t)}},uniqueValues:{value:[]}},this.states={},a.apply(this,arguments)}var i=require("saber-lang"),o=require("saber-string"),a=require("./Widget"),s=require("saber-dom");t.prototype={constructor:t,getNode:function(t){var n={},r=this._root;if(void 0===t||"root"===t)return r;var i=[];for(i.push(r);i.length>0;){n=i.shift();var o=e(n.uniqueValue);if(o===t)break;for(var a=n.children||[],s=0,u=a.length;u>s;s++)i.push(a[s])}return i=null,n},getDepth:function(){return this._depth},update:function(){},_preprocess:function(){function e(r,i){if(n.push(r.value),r.level=r.level||i,r.uniqueValue=n.join("-"),!r.children||0===r.children.length)return void(t=Math.max(t,i));else for(var o=0,a=r.children.length;a>o;o++)e(r.children[o],i+1),n.pop()}var t=-1,n=[];e(this._root,0),this._depth=t}};var u=require("saber-scroll");require("saber-scroll/plugin/scrollbar"),n.prototype={constructor:n,render:function(t){if(t=t||[],t.length){if(this.data=t,this.next&&!this.exist("uniqueValue"))this.uniqueValue=t[0].uniqueValue,this.value=t[0].value;for(var n=[],r='<li class="${className}" data-value="${value}" data-unique-value="${uniqueValue}"><span>${name}</span></li>',a=0,s=t.length;s>a;a++){var c=i.extend({},t[a]),l="",f=e(c.uniqueValue);if(f===this.uniqueValue)l+="linkage-item-cur";if(c.disable)l+="linkage-item-disabled";c.className=l,n.push(o.format(r,c))}if(this.ul.innerHTML=n.join(""),!this._scroller)this._scroller=u(this.main,{scrollbar:!0,horizontal:!1});else this._scroller.repaint();return this}},exist:function(e){var t=this[e];if(null===t)return!1;for(var n=this.data,r=0,i=n.length;i>r;r++){var o=n[r][e];if(t===o)return!0}return!1},scrollToCurrent:function(){var e=s.query(".linkage-item-cur",this.ul);if(e)this._scroller.scrollToElement(e)},_changeHandler:function(t){for(var n=t.target,r=!1;n&&n!==this.main;){if("LI"===n.tagName){r=!0;break}n=n.parentNode}if(!r||s.hasClass(n,"linkage-disabled"))return!1;var i=s.query(".linkage-item-cur",this.main);i&&s.removeClass(i,"linkage-item-cur"),s.addClass(n,"linkage-item-cur");var o=n.getAttribute("data-value");this.value=e(o),this.uniqueValue=n.getAttribute("data-unique-value"),this.emit("change",{target:this,type:"change"},{value:o})},dispose:function(){this.main.removeEventListener("click",this._changeHandler),this.main=null,this.ul=null}},require("saber-emitter").mixin(n.prototype),r.prototype.type="LinkageMenu",r.prototype.initDom=function(){this.main.className="linkage-menu";var e=this.get("datasource");this.runtime.tree=new t(e),this.runtime.linkedList=null,this._linkageItemChangeHandler=i.bind(this._linkageItemChangeHandler,this);for(var r,o,a=this.get("values"),s=this.get("uniqueValues"),u=this.runtime.tree,c=u.getDepth(),l=document.createDocumentFragment(),f=0;c>f;f++){var h=u.getNode(o),p=h.children||[],d=a[f],m=s[f],g=new n({data:p,value:d,uniqueValue:m});if(!this.runtime.linkedList)this.runtime.linkedList=g;else r.next=g;r=g,g.on("change",this._linkageItemChangeHandler),l.appendChild(g.main),o=m}r=null,o=null,this.main.appendChild(l)},r.prototype.initEvent=function(){},r.prototype._linkageItemChangeHandler=function(e,t){var n=e.target;if(null===n.next){for(var r=[],i=this.runtime.linkedList;i;)r.push(i.value),i=i.next;this.set("values",r),this.emit("select",r)}else this._linkage(n),this.emit("linkage",t)},r.prototype._linkage=function(e){for(;e&&e.next;){var t=this.runtime.tree.getNode(e.uniqueValue),n=e.next;n.render(t.children),e=n}},i.inherits(r,a),require("./main").register(r)});