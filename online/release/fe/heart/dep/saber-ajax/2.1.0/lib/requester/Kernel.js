function createAgents(t){var e=clients.http,n=clients.https;return{http:new e.Agent(t),https:new n.Agent(t)}}function request(t,e,n){var r=url.parse(t.url),i=r.protocol||DEFAULT_PROTOCOL;i=i.substring(0,i.length-1);var o={hostname:r.hostname,port:r.port||DEFAULT_PORTS[i]||DEFAULT_PORT,path:r.path,method:t.method,headers:t.headers,agent:(n||defaultAgents)[i]},s=clients[i],a=s.request(o,function(t){var n=[];t.on("data",function(t){n.push(t)}),t.on("end",function(){if(n.length)n=Buffer.concat(n).toString("utf8");else n="";e(null,t,n)})});a.on("error",e);var c=a.abort;if(t.timeout)setTimeout(function(){c.call(a);var t=new Error("TIMEOUT");t.code="timeout",e(t)},t.timeout);return a.abort=function(){c.call(this);var t=new Error("ABORT");t.code="abort",e(t)},a.write(t.body||""),a.end(),a}function log(t,e){var n=t.context,r=n.data.logger;if(r&&r[e]){var i=Array.prototype.slice.call(arguments,2);i[0]="AJAX-"+t.uid+" "+i[0],r[e].apply(r,i)}}function Kernel(t,e){var n=t.headers;if(t.method===METHOD.POST&&!util.findHeader(n,"Content-Type"))n["Content-Type"]="application/x-www-form-urlencoded";var r=t.data;if(!util.isString(r)&&t.stringify!==!1)r=util.stringify(r);log(e,"info","request %s %s %s %s",t.method,t.url,JSON.stringify(n),r);var i,o=e.context,s=o.data.agent;if(s)i=createAgents(s);var a=request({url:t.url,method:t.method,headers:n,body:r,timeout:t.timeout},function(t,n,r){if(!t){var i=n.status=n.statusCode,o=i>=400?"error":"info";log(e,o,"response %s %s\n%s",i,JSON.stringify(n.headers),r)}else if(log(e,"error",t.stack),t.code)t=t.code;e.handle(t,n,r)},i);return a}var METHOD=require("../const").METHOD,util=require("../util"),url=require("url"),DEFAULT_PORT=80,DEFAULT_PROTOCOL="http:",clients={http:require("http"),https:require("https")},defaultAgents=function(){var t=clients.http,e=clients.https,n={maxSockets:1/0};return{http:new t.Agent(n),https:new e.Agent(n)}}(),DEFAULT_PORTS={http:DEFAULT_PORT,https:443};module.exports=Kernel;